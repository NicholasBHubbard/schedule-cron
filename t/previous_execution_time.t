#!perl -w

use Test::More;
use Schedule::Cron;
use Time::ParseDate;

my $time;
my $timeshift = 0; # seconds

while (defined($_=<DATA>) && $_ !~ /end/i) {
  chomp;
  if (/^Reftime:\s*(.*)$/) {
    $time = $1;
    $time =~ s/\#.*$//;
    $time = parsedate($time,UK=>1);
    next;
  }
  if (/^Timeshift: \s*(\d+)/) {
    $timeshift = $1;
    next;
  }
  s/^\s*(.*)\s*/$1/;
  next if /^\#/ || /^$/;
  my @args = split(/\s+/,$_,6);
  my $date;

  my $rest = pop @args;
  my ($col6,$more_args) = split(/\s+/,$rest,2);
  if ($col6 =~ /^[\d\-\*\,\/]+$/)
  {
      push @args,$col6;
      $date = $more_args;
  }
  else
  {
      $date = $rest;
  }

  push @entries,[$time, \@args];
  my $res_date = parsedate($date,UK=>1);
  die "Internal error" unless $res_date;
  push @results,$res_date;
}

my $cron = new Schedule::Cron(sub {});
$cron->set_timeshift($timeshift);

plan tests => scalar(@entries);

my $i;
for ($i=0;$i<=$#entries;$i++)
{
    my $t = $cron->get_previous_execution_time($entries[$i]->[1],$entries[$i]->[0]);
    print "# Cron-Entry: ",join(" ",@{$entries[$i]->[1]}),"\n";
    print "# Ref-Time:   ",scalar(localtime($entries[$i]->[0])),"\n";
    print "# Calculated: ",scalar(localtime($t)),"\n";
    print "# Expected:   ",scalar(localtime($results[$i])),"\n";
    ok($t == $results[$i]);
}
__DATA__
Reftime: Sat Jan 01 00:14:14 2000
Timeshift: 137

# Minutes:
# ========

       *     *     *     *     *     0       00:16 01/01/2000
      20           *     *     *     *       23:20 31/12/1999
      */15         *     *     *     *       00:15 01/01/2000
      10-50        *     *     *     *       00:16 01/01/2000
      10-30/4      *     *     *     *       00:14 01/01/2000
      10           *     *     *     *       00:10 01/01/2000
      18,20        *     *     *     *       23:20 31/12/1999

# Hours:
# ======

       *      21     *     *     *            21:59 31/12/1999
       *      19     *     *     *            19:59 31/12/1999
       * 10-23/5     *     *     *            20:59 31/12/1999
       * 10-23/7     *     *     *            17:59 31/12/1999

# Days-of-Month:
# ==============

      *        *    29              2        *         23:59 29/02/1996
      23       4    23-30/3         *        *         04:23 29/12/1999
      12       21   27              *        *         21:12 27/12/1999
      12       19   27              *        *         19:12 27/12/1999
       *       18   21,15,8          *        *        18:59 21/12/1999

# Months:
# =======

        *        *        *       11        *         23:59 30/11/1999
        *        *        *       12        *         23:59 31/12/1999
        *        *        *        0        *         00:16 01/01/2000
       42        0        4  Jan-Dec        *         00:42 04/12/1999
       42       21        4 Jan-Dec/2       *         21:42 04/11/1999
       42       21        * Feb-Dec/2       *         21:42 31/12/1999
       42       19        * Feb-Dec/2       *         19:42 31/12/1999
       42       19       27 Feb-Dec/2       *         19:42 27/12/1999

# Days-of-Week:
# =============

       14       15        *  Dec,Jan        0         15:14 26/12/1999
       14       15        *  Dec,Jan        7         15:14 26/12/1999
        0       12        *        *      Mon-Fri     12:00 31/12/1999
        *        *        *        *      Mon         23:59 27/12/1999
        0       21        *        *      Mon         21:00 27/12/1999
        0       19        *        *      Mon         19:00 27/12/1999
       13       14        *        *      Sun-Sat/2   14:13 30/12/1999

# Seconds
       *      *     *     *     *   *        00:16:31 01/01/2000
       *      *     *     *     *   5-10     00:16:10 01/01/2000
       *      *     *     *     *   13-30/4  00:16:29 01/01/2000
       *      *     *     *     *   18       00:16:18 01/01/2000

# Horrible combinations ;-):
# ==========================

        0       21       27        *      Wed          21:00 29/12/1999
        0       19       27        *      Wed          19:00 29/12/1999
        0    19,21       27        *      Wed          21:00 29/12/1999
20-30/5,17   19,21       27        *      Wed          21:30 29/12/1999

# Check for parsedate-normalization
# (thanx to Lars Holokowo)
# =================================

        1        3       30        6        *         03:01 30/06/1999
        0       03       30        6        *         03:00 30/06/1999
       00        3       30        6        *         03:00 30/06/1999
        0        3       30        6        *         03:00 30/06/1999

# Bug reported by Loic Paillotin
# ==============================
        5,10,25,30,35,40,45,50,55 *   *  *  *         00:10 01/01/2000
        5,10,25,30,35,40,45,50,55 * * * *               00:10 01/01/2000
        */5                       *   *  *  *         00:15 01/01/2000

# Customer
# ========

7,22,37,52  *        *        *        *                 00:07 01/01/2000
30          1,13     *        *        *                 13:30 31/12/1999
31          1,13     *        *        *                 13:31 31/12/1999
0,5,10,15,20,25,30,35,40,45,50,55  *  *  *  *            00:15 01/01/2000
50          5,8,11   *        *        *                 11:50 31/12/1999
50          14       *        4-9      *                 14:50 30/09/1999
0           8,20     *        *        *                 20:00 31/12/1999
0           5,17     *        *        *                 17:00 31/12/1999
2           5,17     *        *        *                 17:02 31/12/1999
3           5,17     *        *        *                 17:03 31/12/1999
4,9,14,19,24,29,34,39,44,49,54,59  *  *  *  *            00:14 01/01/2000
0           13       *        *        *                 13:00 31/12/1999
30          18       *        *        *                 18:30 31/12/1999
31          6        *        *        *                 06:31 31/12/1999
32          6        *        *        *                 06:32 31/12/1999
30,45       6,18     *        *        *                 18:45 31/12/1999
0           7,19     *        *        *                 19:00 31/12/1999

end
